<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root {
  --bg:#fafafa;
  --card:#fff;
  --muted:#666;
  --accent:#1976d2;
  --danger:#e53935;
  --warning:#ff9800;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
  background:var(--bg);
  color:#222;
}

#app{
  display:grid;
  grid-template-columns:1fr 400px;
  gap:12px;
  height:100vh;
  padding:12px;
  box-sizing:border-box;
}

#map{
  height:100%;
  width:100%;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.panel{
  background:var(--card);
  padding:12px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
  overflow:auto;
  display:flex;
  flex-direction:column;
}

h2{
  margin:4px 0 12px;
  font-size:18px;
}

.info-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
  margin-bottom:12px;
}

.stat{
  background:#f7f7f8;
  padding:10px;
  border-radius:6px;
  font-size:0.9em;
  text-align:center;
}

.stat div{
  font-weight:600;
  margin-top:4px;
}

.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
  gap:8px;
  margin-bottom:12px;
}

button{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:10px;
  border-radius:6px;
  cursor:pointer;
  font-size:0.9em;
}

button.secondary{background:#444;}
button.warning{background:var(--warning);}
button.danger{background:var(--danger);}

.row{
  display:flex;
  gap:8px;
  align-items:center;
  font-size:0.85em;
}

#log{
  max-height:35vh;
  overflow:auto;
  font-size:0.85em;
  background:#f5f5f5;
  padding:6px;
  border-radius:6px;
}

/* ===== ãƒ­ã‚°ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« ===== */
.log-entry{
  background:#f7f7f8;
  margin-bottom:6px;
  padding:8px;
  border-radius:6px;
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}

.log-entry .time{
  font-weight:600;
  margin-bottom:4px;
  font-size:0.85em;
  color:#444;
}

.log-entry .coords{
  font-size:0.8em;
  color:#666;
  margin-bottom:4px;
}

.log-entry .address{
  font-size:0.85em;
  font-weight:500;
  margin-bottom:4px;
}

.log-entry .info{
  display:flex;
  gap:6px;
  font-size:0.8em;
}

.log-entry .accuracy{
  font-weight:600;
}

.acc-green{color:green;}
.acc-yellowgreen{color:yellowgreen;}
.acc-orange{color:orange;}
.acc-red{color:red;}

@media(max-width:900px){
  #app{
    grid-template-columns:1fr;
    grid-template-rows:65vh auto;
  }
  .panel{
    max-height:calc(100vh - 65vh);
  }
  .controls{
    grid-template-columns:repeat(auto-fit,minmax(80px,1fr));
  }
}
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div class="panel">
    <h2>ğŸ“ ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</h2>
    <div class="info-grid">
      <div class="stat">ç·¯åº¦: <div id="lat">---</div></div>
      <div class="stat">çµŒåº¦: <div id="lng">---</div></div>
      <div class="stat">ç²¾åº¦: <div id="acc">---</div></div>
      <div class="stat">é«˜åº¦: <div id="alt">---</div></div>
      <div class="stat">é€Ÿåº¦: <div id="speed">---</div></div>
      <div class="stat">æ–¹è§’: <div id="heading">---</div></div>
    </div>
    <div class="row small">ä½æ‰€: <div id="address" style="margin-left:8px;font-weight:600">---</div></div>
    <div class="row small">æœ€çµ‚æ›´æ–°: <span id="lastAge" style="margin-left:8px">---</span></div>
    <div style="height:8px"></div>
    <div class="controls">
      <button id="stopBtn" class="danger">è¦³æ¸¬åœæ­¢</button>
      <button id="restartBtn">å†é–‹</button>
      <button id="centerToggle" class="secondary">è‡ªå‹•è¿½å°¾: ON</button>
      <button id="exportJsonBtn" class="warning">JSONä¿å­˜</button>
      <button id="exportCsvBtn" class="warning">CSVä¿å­˜</button>
      <button id="clearBtn" class="secondary">ãƒ­ã‚°/çµŒè·¯ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="row" style="margin:8px 0;gap:12px;align-items:center">
      <div>ç·è·é›¢: <strong id="totalDist">0 m</strong></div>
      <div>å¹³å‡é€Ÿåº¦: <strong id="avgSpeed">0 km/h</strong></div>
    </div>
    <div style="margin-top:8px">
      <label>ãƒ­ã‚°</label>
      <div id="log" class="panel" style="padding:8px;margin-top:6px"></div>
    </div>
    <div style="margin-top:10px" class="small">â€» Nominatim é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯1ç§’æœªæº€ã®é€£ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é¿ã‘ã¦ã„ã¾ã™ã€‚</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker, watchId=null, pathSegments=[[]], polylines=[], logData=[];
let lastFetchTime=0, lastPosTime=0, follow=true;
const LS_KEYS={PATH:'hp_map_path_v3', LOG:'hp_map_log_v3'};

// ===== åˆæœŸåŒ– =====
function initMap(){
  map=L.map('map').setView([35.6812,139.7671],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}).addTo(map);
  map.on('dragstart',()=>{follow=false;document.getElementById('centerToggle').textContent='è‡ªå‹•è¿½å°¾: OFF';});
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const toFixedOrDash=(v,d=6)=>typeof v==='number'?v.toFixed(d):'---';
const now=()=>Date.now();
const haversine=(a,b)=>{const R=6371e3,toRad=d=>d*Math.PI/180;const Ï†1=toRad(a[0]),Ï†2=toRad(b[0]);const Î”Ï†=toRad(b[0]-a[0]),Î”Î»=toRad(b[1]-a[1]);const aa=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));};
const directionName=deg=>{if(deg===null||isNaN(deg))return '---';const dirs=['åŒ—','åŒ—æ±','æ±','å—æ±','å—','å—è¥¿','è¥¿','åŒ—è¥¿'];return `${dirs[Math.round(deg/45)%8]} (${deg.toFixed(0)}Â°)`;};

// ===== è·é›¢ãƒ»é€Ÿåº¦ =====
function calcTotalDistance(){let t=0;for(const seg of pathSegments)for(let i=1;i<seg.length;i++)t+=haversine(seg[i-1],seg[i]);return t;}
function calcAvgSpeed(){if(logData.length<2)return 0;const first=new Date(logData[logData.length-1]?.time||now()).getTime();const last=new Date(logData[0]?.time||now()).getTime();const dt=Math.abs(last-first)/1000;if(dt<=0)return 0;return (calcTotalDistance()/dt)*3.6;}
function updateStatsUI(){document.getElementById('totalDist').textContent=(calcTotalDistance()/1000).toFixed(3)+' km';document.getElementById('avgSpeed').textContent=calcAvgSpeed().toFixed(2)+' km/h';}

// ===== ä¿å­˜ / å¾©å…ƒ =====
function safeSaveLocal(){try{localStorage.setItem(LS_KEYS.PATH,JSON.stringify(pathSegments));localStorage.setItem(LS_KEYS.LOG,JSON.stringify(logData));}catch(e){console.warn('save error',e);}}
function restoreLocal(){
  try{
    const rawP=localStorage.getItem(LS_KEYS.PATH),rawL=localStorage.getItem(LS_KEYS.LOG);
    if(rawP)pathSegments=JSON.parse(rawP);if(rawL)logData=JSON.parse(rawL);
    const log=document.getElementById('log'); log.innerHTML='';
    for(const e of logData.slice(0,200)){
      addLogEntry(e,true); // true = restoreãƒ¢ãƒ¼ãƒ‰ï¼ˆUIã«å†ä¿å­˜ã—ãªã„ï¼‰
    }
  }catch(e){console.warn('restore error',e);}
}

// ===== ãƒãƒªãƒ©ã‚¤ãƒ³ =====
function redrawPolylines(){polylines.forEach(p=>map.removeLayer(p));polylines=[];for(const seg of pathSegments){if(seg.length<2)continue;polylines.push(L.polyline(seg,{color:'#ff4444',weight:4,opacity:0.9}).addTo(map));}}

// ===== ä½æ‰€å–å¾— =====
async function fetchAddress(lat,lng){if(now()-lastFetchTime<1000)return 'å–å¾—é–“éš”åˆ¶å¾¡ä¸­';lastFetchTime=now();try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`);if(!r.ok)return 'ä½æ‰€å–å¾—å¤±æ•—';const d=await r.json();return d.display_name||'ä½æ‰€æƒ…å ±ãªã—';}catch(e){return 'ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼';}}

// ===== ãƒ­ã‚°è¿½åŠ ï¼ˆã‚«ãƒ¼ãƒ‰åŒ–ï¼‹è‰²åˆ†ã‘ï¼‰ =====
function addLogEntry(e,restoreMode=false){
  if(!restoreMode) logData.unshift(e);

  // ç²¾åº¦ã«å¿œã˜ãŸè‰²
  let accClass='acc-red';
  if(e.accuracy<5) accClass='acc-green';
  else if(e.accuracy<15) accClass='acc-yellowgreen';
  else if(e.accuracy<30) accClass='acc-orange';

  const html=`
    <div class="log-entry">
      <div class="time">ğŸ•’ ${new Date(e.time).toLocaleString()}</div>
      <div class="coords">(${e.lat.toFixed(6)}, ${e.lng.toFixed(6)})</div>
      <div class="address">ğŸ“ ${e.address}</div>
      <div class="info">
        <div class="accuracy ${accClass}">ç²¾åº¦:${e.accuracy.toFixed(1)}m</div>
        <div>é€Ÿåº¦:${e.speedText}</div>
        <div>æ–¹è§’:${e.headingText}</div>
      </div>
    </div>
  `;
  const logContainer=document.getElementById('log');
  logContainer.insertAdjacentHTML('afterbegin',html);

  // ãƒ­ã‚°ä»¶æ•°åˆ¶é™
  while(logContainer.childElementCount>200){
    logContainer.removeChild(logContainer.lastChild);
  }

  if(!restoreMode){
    safeSaveLocal();
    updateStatsUI();
  }
}

// ===== ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
function download(filename,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));a.download=filename;a.click();}
document.getElementById('exportJsonBtn').addEventListener('click',()=>{download('location_log.json',JSON.stringify({pathSegments,logData,savedAt:new Date().toISOString()},null,2));});
document.getElementById('exportCsvBtn').addEventListener('click',()=>{const h=['time,lat,lng,accuracy,speed_kmh,heading,address'];const rows=logData.map(e=>`${JSON.stringify(e.time)},${e.lat},${e.lng},${e.accuracy},${parseFloat(e.speedKmh)||''},${JSON.stringify(e.headingText)},${JSON.stringify(e.address)}`);download('location_log.csv',h.concat(rows).join('\n'));});

// ===== åœæ­¢/å†é–‹/ã‚¯ãƒªã‚¢ =====
document.getElementById('stopBtn').addEventListener('click',()=>{if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;pathSegments.push([]);alert('è¦³æ¸¬åœæ­¢');}});
document.getElementById('restartBtn').addEventListener('click',()=>{if(!watchId)startTracking();alert('è¦³æ¸¬å†é–‹');});
document.getElementById('clearBtn').addEventListener('click',()=>{if(confirm('æœ¬å½“ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){pathSegments=[[]];logData=[];redrawPolylines();document.getElementById('log').innerHTML='';safeSaveLocal();updateStatsUI();}});

// ===== è‡ªå‹•è¿½å°¾ =====
document.getElementById('centerToggle').addEventListener('click',()=>{follow=!follow;document.getElementById('centerToggle').textContent=`è‡ªå‹•è¿½å°¾: ${follow?'ON':'OFF'}`;});

// ===== ä½ç½®æ›´æ–°ï¼ˆé«˜é€Ÿå¯¾å¿œï¼‰ =====
async function handlePosition(pos){
  const c=pos.coords;
  const lat=c.latitude,lng=c.longitude,acc=c.accuracy||0;
  const alt=c.altitude; const speed=(typeof c.speed==='number'&&c.speed>=0)?c.speed:null;
  const heading=(typeof c.heading==='number')?c.heading:null;

  document.getElementById('lat').textContent=toFixedOrDash(lat,6);
  document.getElementById('lng').textContent=toFixedOrDash(lng,6);
  document.getElementById('acc').textContent=`${acc.toFixed(1)} m`;
  document.getElementById('alt').textContent=alt===null?'---':`${alt.toFixed(1)} m`;
  document.getElementById('speed').textContent=speed?`${(speed*3.6).toFixed(1)} km/h`:'---';
  document.getElementById('heading').textContent=directionName(heading);

  let accColor='red';
  if(acc<5) accColor='green';
  else if(acc<15) accColor='yellowgreen';
  else if(acc<30) accColor='orange';

  let size=16;
  if(speed && speed*3.6>200) size=20; // é«˜é€Ÿãªã‚‰ãƒãƒ¼ã‚«ãƒ¼å¤§ãã

  document.getElementById('acc').style.color=accColor;

  const icon=L.divIcon({className:'custom-marker',html:`<div style="width:${size}px;height:${size}px;border-radius:50%;background:${accColor};border:2px solid #fff"></div>`,iconSize:[size,size],iconAnchor:[size/2,size/2]});
  if(!marker) marker=L.marker([lat,lng],{icon}).addTo(map);
  else marker.setLatLng([lat,lng]).setIcon(icon);

  pathSegments[pathSegments.length-1].push([lat,lng]);
  redrawPolylines();
  if(follow) map.setView([lat,lng]);

  const addr=await fetchAddress(lat,lng);
  document.getElementById('address').textContent=addr;

  const time=new Date().toISOString();
  const speedText=speed?`${(speed*3.6).toFixed(1)} km/h`:'---';
  const headingText=directionName(heading);
  addLogEntry({time,lat,lng,accuracy:acc,altitude:alt,speedKmh:speed?speed*3.6:null,speedText,headingText,address:addr});

  lastPosTime=now();
  document.getElementById('lastAge').textContent='0ç§’å‰';
}

// ===== ã‚¨ãƒ©ãƒ¼å‡¦ç† =====
let retryTimer=null;
function clearRetryTimer(){if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}}
function handleError(err){console.warn('ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼',err);if(!retryTimer)retryTimer=setTimeout(()=>{startTracking();},3000);}

// ===== ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–‹å§‹ =====
function startTracking(){if(!navigator.geolocation){alert('ä½ç½®æƒ…å ±æœªå¯¾å¿œ');return;}watchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,timeout:15000,maximumAge:0});}

// ===== æ›´æ–°ç§’ =====
setInterval(()=>{if(lastPosTime){document.getElementById('lastAge').textContent=`${Math.floor((now()-lastPosTime)/1000)}ç§’å‰`; }},1000);

// ===== DeviceOrientation =====
async function setupDeviceOrientation(){
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    const btn=document.createElement('button');btn.textContent='ã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯';btn.className='warning';btn.style.margin='6px';document.querySelector('.panel').appendChild(btn);
    btn.addEventListener('click',async()=>{try{const perm=await DeviceOrientationEvent.requestPermission();if(perm==='granted'){window.addEventListener('deviceorientationabsolute',onDeviceOrientation);btn.remove();}else alert('æ‹’å¦');}catch(e){alert('æ¨©é™ã‚¨ãƒ©ãƒ¼:'+e.message);}});
  }else if(window.DeviceOrientationEvent)window.addEventListener('deviceorientationabsolute',onDeviceOrientation);
}
function onDeviceOrientation(e){if(e && typeof e.alpha==='number'){const heading=(360-e.alpha)%360;document.getElementById('heading').textContent=directionName(heading);}}

// ===== åˆæœŸãƒ­ãƒ¼ãƒ‰ =====
window.addEventListener('load',()=>{
  initMap();
  restoreLocal();
  redrawPolylines();
  setupDeviceOrientation();
  startTracking();
});
</script>
</body>
</html>
