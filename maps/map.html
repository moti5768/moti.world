<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#666}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#222}
    #app{display:grid;grid-template-columns:1fr 380px;gap:12px;height:100vh;padding:12px;box-sizing:border-box}
    #map{height:100%;width:100%;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .panel{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow:auto}
    h2{margin:4px 0 12px;font-size:18px}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    .stat{background:#f7f7f8;padding:8px;border-radius:6px}
    #log{max-height:38vh;overflow:auto;font-size:0.9em}
    button{background:#1976d2;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#444}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    label{font-size:0.85em;color:var(--muted)}
    .small{font-size:0.85em;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    @media(max-width:900px){#app{grid-template-columns:1fr;grid-template-rows:60vh auto}}
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div class="panel">
      <h2>ğŸ“ é«˜ç²¾åº¦ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</h2>

      <div class="info-grid">
        <div class="stat">ç·¯åº¦: <div id="lat">---</div></div>
        <div class="stat">çµŒåº¦: <div id="lng">---</div></div>
        <div class="stat">ç²¾åº¦: <div id="acc">---</div></div>
        <div class="stat">é«˜åº¦: <div id="alt">---</div></div>
        <div class="stat">é€Ÿåº¦: <div id="speed">---</div></div>
        <div class="stat">æ–¹è§’: <div id="heading">---</div></div>
      </div>

      <div class="row small">ä½æ‰€: <div id="address" style="margin-left:8px;font-weight:600">---</div></div>
      <div class="row small">æœ€çµ‚æ›´æ–°: <span id="lastAge" style="margin-left:8px">---</span></div>

      <div style="height:8px"></div>
      <div class="controls">
        <button id="stopBtn">è¦³æ¸¬åœæ­¢</button>
        <button id="restartBtn">å†é–‹</button>
        <button id="centerToggle" class="secondary">è‡ªå‹•è¿½å°¾: ON</button>
        <button id="exportJsonBtn">JSONä¿å­˜</button>
        <button id="exportCsvBtn">CSVä¿å­˜</button>
        <button id="clearBtn" class="secondary">ãƒ­ã‚°/çµŒè·¯ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="row" style="margin:8px 0;gap:12px;align-items:center">
        <div>ç·è·é›¢: <strong id="totalDist">0 m</strong></div>
        <div>å¹³å‡é€Ÿåº¦: <strong id="avgSpeed">0 km/h</strong></div>
      </div>

      <div style="margin-top:8px">
        <label>ãƒ­ã‚°</label>
        <div id="log" class="panel" style="padding:8px;margin-top:6px"></div>
      </div>

      <div style="margin-top:10px" class="small">â€» Nominatim é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯1ç§’æœªæº€ã®é€£ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é¿ã‘ã¦ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ======= çŠ¶æ…‹ =======
  let map, marker, watchId = null;
  let pathSegments = [[]]; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†ã‘ï¼ˆåœæ­¢â†’æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
  let polylines = []; // Leaflet polyline objects
  let logData = [];
  let lastFetchTime = 0;
  let lastPosTime = 0;
  let follow = true; // è‡ªå‹•è¿½å°¾

  const LS_KEYS = { PATH: 'hp_map_path_v1', LOG: 'hp_map_log_v1', SETTINGS: 'hp_map_settings_v1' };

  // ======= åˆæœŸåŒ– =======
  function initMap(){
    map = L.map('map').setView([35.6812,139.7671],15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}).addTo(map);
  }

  // ======= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =======
  function toFixedOrDash(val, digits=6){ return (typeof val === 'number') ? val.toFixed(digits) : '---'; }
  function now(){ return Date.now(); }

  function haversine(a, b){
    // a=[lat,lng], b=[lat,lng]
    const R = 6371e3;
    const toRad = d => d * Math.PI/180;
    const Ï†1 = toRad(a[0]), Ï†2 = toRad(b[0]);
    const Î”Ï† = toRad(b[0]-a[0]);
    const Î”Î» = toRad(b[1]-a[1]);
    const aa = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
  }

  function calcTotalDistance(){
    let total = 0;
    for(const seg of pathSegments){
      for(let i=1;i<seg.length;i++) total += haversine(seg[i-1], seg[i]);
    }
    return total; // m
  }

  function calcAvgSpeed(){
    // average over logged moving speed (if available) else compute from distance/time
    const distances = calcTotalDistance();
    if(logData.length<2) return 0;
    const t0 = new Date(logData[logData.length-1].time).getTime();
    const tFirst = new Date(logData[logData.length-1]).getTime();
    // safer: compute total time from first to last in ms
    const first = new Date(logData[logData.length-1]?.time || Date.now()).getTime();
    const last = new Date(logData[0]?.time || Date.now()).getTime();
    const dt = Math.abs(last - first) / 1000; // s
    if(dt<=0) return 0;
    const mps = distances / dt; // m/s
    return (mps * 3.6); // km/h
  }

  function directionName(deg){ if(deg===null||isNaN(deg)) return '---'; const dirs=['åŒ—','åŒ—æ±','æ±','å—æ±','å—','å—è¥¿','è¥¿','åŒ—è¥¿']; const idx=Math.round(deg/45)%8; return `${dirs[idx]} (${deg.toFixed(0)}Â°)` }

  // ======= ä½æ‰€å–å¾—ï¼ˆç°¡æ˜“ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ï¼‰ =======
  async function fetchAddress(lat,lng){
    const nowt = now();
    if(nowt - lastFetchTime < 1000) return 'å–å¾—é–“éš”åˆ¶å¾¡ä¸­';
    lastFetchTime = nowt;
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`;
      const res = await fetch(url);
      if(!res.ok) return 'ä½æ‰€å–å¾—å¤±æ•—';
      const data = await res.json();
      return data.display_name || 'ä½æ‰€æƒ…å ±ãªã—';
    }catch(e){ return 'ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼'; }
  }

  // ======= UI æ›´æ–° =======
  function updateStatsUI(){
    document.getElementById('totalDist').textContent = `${(calcTotalDistance()/1000).toFixed(3)} km`;
    const avg = calcAvgSpeed();
    document.getElementById('avgSpeed').textContent = `${avg.toFixed(2)} km/h`;
  }

  function addLogEntry(entry){
    logData.unshift(entry);
    // è¡¨ç¤º
    const html = `<div>ğŸ•’ ${new Date(entry.time).toLocaleString()}<br><span class="small">(${entry.lat.toFixed(6)}, ${entry.lng.toFixed(6)})</span><br>ğŸ“ ${entry.address}<br>ğŸ” ç²¾åº¦:${entry.accuracy.toFixed(1)}m é€Ÿåº¦:${entry.speedText} æ–¹è§’:${entry.headingText}</div><hr>`;
    const log = document.getElementById('log');
    log.insertAdjacentHTML('afterbegin', html);
    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
    safeSaveLocal();
    updateStatsUI();
  }

  // ======= ãƒãƒªãƒ©ã‚¤ãƒ³ç®¡ç† =======
  function redrawPolylines(){
    // clear existing
    polylines.forEach(p=>map.removeLayer(p)); polylines = [];
    for(const seg of pathSegments){
      if(seg.length<2) continue;
      const p = L.polyline(seg, {color:'#ff4444', weight:4, opacity:0.9}).addTo(map);
      polylines.push(p);
    }
  }

  // ======= ä¿å­˜ / å¾©å…ƒ =======
  function safeSaveLocal(){
    try{ localStorage.setItem(LS_KEYS.PATH, JSON.stringify(pathSegments)); localStorage.setItem(LS_KEYS.LOG, JSON.stringify(logData)); }
    catch(e){ console.warn('localStorage save error', e); }
  }
  function restoreLocal(){
    try{
      const rawPath = localStorage.getItem(LS_KEYS.PATH);
      const rawLog = localStorage.getItem(LS_KEYS.LOG);
      if(rawPath) pathSegments = JSON.parse(rawPath);
      if(rawLog) logData = JSON.parse(rawLog);
      // render log
      const log = document.getElementById('log'); log.innerHTML = '';
      for(const e of logData.slice(0,200)){
        const html = `<div>ğŸ•’ ${new Date(e.time).toLocaleString()}<br><span class="small">(${e.lat.toFixed(6)}, ${e.lng.toFixed(6)})</span><br>ğŸ“ ${e.address}<br>ğŸ” ç²¾åº¦:${e.accuracy.toFixed(1)}m é€Ÿåº¦:${e.speedText} æ–¹è§’:${e.headingText}</div><hr>`;
        log.insertAdjacentHTML('afterbegin', html);
      }
    }catch(e){ console.warn('restore error', e); }
  }

  // ======= ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ =======
  function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); }
  document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
    const obj = { pathSegments, logData, savedAt: new Date().toISOString() };
    download('location_log.json', JSON.stringify(obj, null, 2));
  });
  document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
    const header = ['time,lat,lng,accuracy,speed_kmh,heading,address'];
    const rows = logData.map(e=>`${JSON.stringify(e.time)},${e.lat},${e.lng},${e.accuracy},${parseFloat(e.speedKmh)||''},${JSON.stringify(e.headingText)},${JSON.stringify(e.address)}`);
    download('location_log.csv', header.concat(rows).join('\n'));
  });

  // ======= è¿½å°¾ãƒˆã‚°ãƒ« =======
  document.getElementById('centerToggle').addEventListener('click', ()=>{ follow = !follow; document.getElementById('centerToggle').textContent = `è‡ªå‹•è¿½å°¾: ${follow? 'ON':'OFF'}` });

  // ======= åœæ­¢ / å†é–‹ =======
  function stopTracking(){
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; pathSegments.push([]); // æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç”¨æ„
      alert('ä½ç½®è¦³æ¸¬ã‚’åœæ­¢ã—ã¾ã—ãŸ');
    }
  }
  function restartTracking(){ if(!watchId){ startTracking(); alert('è¦³æ¸¬ã‚’å†é–‹ã—ã¾ã™'); } }
  document.getElementById('stopBtn').addEventListener('click', stopTracking);
  document.getElementById('restartBtn').addEventListener('click', restartTracking);

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('ãƒ­ã‚°ã¨çµŒè·¯ã‚’æœ¬å½“ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){
      pathSegments = [[]]; logData = []; redrawPolylines(); document.getElementById('log').innerHTML = ''; safeSaveLocal(); updateStatsUI();
    }
  });

  // ======= ä½ç½®å–å¾— =======
  async function handlePosition(pos){
    clearRetryTimer();
    const coords = pos.coords;
    const lat = coords.latitude, lng = coords.longitude, accuracy = coords.accuracy || 0;
    const altitude = coords.altitude;
    const speed = (typeof coords.speed === 'number' && coords.speed >= 0) ? coords.speed : null; // m/s
    const heading = (typeof coords.heading === 'number') ? coords.heading : null;

    document.getElementById('lat').textContent = toFixedOrDash(lat,6);
    document.getElementById('lng').textContent = toFixedOrDash(lng,6);
    document.getElementById('acc').textContent = `${accuracy.toFixed(1)} m`;
    document.getElementById('alt').textContent = altitude===null? '---' : `${altitude.toFixed(1)} m`;
    document.getElementById('speed').textContent = speed? `${(speed*3.6).toFixed(1)} km/h` : '---';
    document.getElementById('heading').textContent = directionName(heading);

    // ç²¾åº¦è‰²åˆ†ã‘
    const accElem = document.getElementById('acc');
    if(accuracy < 10) accElem.style.color = 'green'; else if(accuracy < 30) accElem.style.color = 'orange'; else accElem.style.color = 'red';

    // ãƒãƒ¼ã‚«ãƒ¼
    if(!marker){ marker = L.marker([lat,lng]).addTo(map); } else { marker.setLatLng([lat,lng]); }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«è¿½åŠ 
    const seg = pathSegments[pathSegments.length-1];
    seg.push([lat,lng]);
    redrawPolylines();

    // åœ°å›³ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
    if(follow) map.setView([lat,lng]);

    // ä½æ‰€ï¼ˆåˆ¶é™ä»˜ãï¼‰
    const addr = await fetchAddress(lat,lng);
    document.getElementById('address').textContent = addr;

    // ãƒ­ã‚°
    const time = new Date().toISOString();
    const speedText = speed? `${(speed*3.6).toFixed(1)} km/h` : '---';
    const headingText = directionName(heading);
    const entry = { time, lat, lng, accuracy, altitude: altitude, speedKmh: speed? (speed*3.6): null, speedText, headingText, address: addr };
    addLogEntry(entry);

    lastPosTime = now();
    document.getElementById('lastAge').textContent = '0ç§’å‰';
  }

  // ======= ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨å†æ¥ç¶š =======
  let retryTimer = null;
  function clearRetryTimer(){ if(retryTimer){ clearTimeout(retryTimer); retryTimer = null; } }
  function handleError(err){ console.warn('ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼', err); if(!retryTimer){ retryTimer = setTimeout(()=>{ console.log('å†æ¥ç¶šè©¦è¡Œ'); startTracking(); }, 3000); } }

  function startTracking(){
    if(!navigator.geolocation){ alert('ã“ã®ç’°å¢ƒã§ã¯ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚'); return; }
    const opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
    watchId = navigator.geolocation.watchPosition(handlePosition, handleError, opts);
  }

  // ======= æ›´æ–°æ™‚é–“è¡¨ç¤ºï¼ˆçµŒéç§’ï¼‰ =======
  setInterval(()=>{
    if(lastPosTime){ const s = Math.floor((now()-lastPosTime)/1000); document.getElementById('lastAge').textContent = `${s}ç§’å‰`; }
  },1000);

  // ======= DeviceOrientation ã‚’ä½¿ã£ãŸæ–¹è§’è£œå®Œï¼ˆiOSã¯è¨±å¯UIãŒå¿…è¦ï¼‰ =======
  async function setupDeviceOrientation(){
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      // iOS 13+ requires user gesture
      const btn = document.createElement('button'); btn.textContent='ã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ'; btn.style.margin='8px';
      document.querySelector('.panel').appendChild(btn);
      btn.addEventListener('click', async ()=>{
        try{
          const perm = await DeviceOrientationEvent.requestPermission();
          if(perm === 'granted'){
            window.addEventListener('deviceorientationabsolute', onDeviceOrientation);
            btn.remove();
          } else alert('ã‚³ãƒ³ãƒ‘ã‚¹æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }catch(e){ alert('æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    } else if(window.DeviceOrientationEvent){ window.addEventListener('deviceorientationabsolute', onDeviceOrientation); }
  }
  function onDeviceOrientation(e){
    if(e && typeof e.alpha === 'number'){
      // alpha = 0..360, 0 = device facing north? convert to heading
      const heading = (360 - e.alpha) % 360; // è£œæ­£
      document.getElementById('heading').textContent = directionName(heading);
    }
  }

  // ======= ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º =======
  window.addEventListener('offline', ()=>{ alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸï¼ˆä½æ‰€å–å¾—ãªã©ãŒã§ããªããªã‚Šã¾ã™ï¼‰'); });
  window.addEventListener('online', ()=>{ console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°'); });

  // ======= ãƒãƒƒãƒ—æ“ä½œã«ã‚ˆã‚‹è¿½å°¾åœæ­¢ =======
  map?.on && map.on('movestart', ()=>{ /* noop before init */ });
  function enableMapFollowToggle(){
    map.on('dragstart', ()=>{ follow=false; document.getElementById('centerToggle').textContent = `è‡ªå‹•è¿½å°¾: OFF`; });
  }

  // ======= åˆæœŸãƒ­ãƒ¼ãƒ‰ =======
  window.addEventListener('load', async ()=>{
    initMap();
    restoreLocal();
    redrawPolylines();
    enableMapFollowToggle();
    setupDeviceOrientation();
    startTracking();
  });
  </script>
</body>
</html>
