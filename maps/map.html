<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>é«˜ç²¾åº¦ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <!-- Leaflet æœ¬ä½“ (å¿…ãš Routing Machine ã‚ˆã‚Šå…ˆ) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Routing Machine æœ¬ä½“ -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    :root {
      --bg: #e8f0f8;
      --card: rgba(255, 255, 255, 0.95);
      --muted: #555;
      --accent: #1976d2;
      --danger: #e53935;
      --warning: #ff9800;
      --marker-border: #fff;
      --polyline-color: #ff4444;
      --polyline-weight: 5;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
      background: var(--bg);
      color: #222;
    }

    #app {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 12px;
      height: 100vh;
      padding: 12px;
      box-sizing: border-box;
    }

    #map {
      height: 100%;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .panel {
      position: relative;
      background: var(--card);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      overflow: auto;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }

    h2 {
      margin: 6px 0 14px;
      font-size: 20px;
      color: var(--accent);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }

    .stat {
      background: #f9f9fb;
      padding: 3px;
      border-radius: 8px;
      font-size: 0.95em;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .stat div {
      font-weight: 600;
      margin-top: 4px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 3px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
      transition: 0.2s;
    }

    button:hover {
      opacity: 0.85;
    }

    button.secondary {
      background: #666;
    }

    button.warning {
      background: var(--warning);
    }

    button.danger {
      background: var(--danger);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.87em;
    }

    #log-container {
      /* ãƒ­ã‚°ç”¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
      height: 35vh;
      /* æœ€å¤§å±•é–‹é«˜ã• */
      min-height: 40px;
      /* æŠ˜ã‚ŠãŸãŸã‚“ã ã¨ãã®æœ€å°ã‚¹ãƒšãƒ¼ã‚¹ */
      overflow: hidden;
      transition: height 0.5s ease;
    }

    #log {
      height: 100%;
      overflow: auto;
      padding: 8px;
      background: #f3f6fa;
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      opacity: 1;
      transition: opacity 0.4s ease, padding 0.3s ease;
    }

    #log.collapsed {
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .log-entry {
      background: #f7f7f8;
      margin-bottom: 6px;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.08);
    }

    .log-entry .time {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.85em;
      color: #333;
    }

    .log-entry .coords {
      font-size: 0.82em;
      color: #555;
      margin-bottom: 4px;
    }

    .log-entry .address {
      font-size: 0.87em;
      font-weight: 500;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .log-entry .info {
      display: flex;
      gap: 8px;
      font-size: 0.82em;
    }

    .log-entry .accuracy {
      font-weight: 600;
    }

    .acc-green {
      color: green;
    }

    .acc-yellowgreen {
      color: yellowgreen;
    }

    .acc-orange {
      color: orange;
    }

    .acc-red {
      color: red;
    }

    @media(max-width:900px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 65vh auto;
      }

      .panel {
        max-height: calc(100vh - 65vh);
      }

      .controls {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      }
    }

    .leaflet-control-attribution {
      font-size: 10px;
      opacity: 0.8;
    }

    .custom-marker div {
      border: 2px solid var(--marker-border);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      border-radius: 50%;
    }


    /* ãƒ«ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒƒãƒ—ãƒ‘ãƒãƒ« */
    .leaflet-routing-container {
      display: flex;
      flex-direction: column;
      width: 220px;
      height: auto;
      /* é«˜ã•å›ºå®š */
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 6px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* ãƒ˜ãƒƒãƒ€å›ºå®š */
    .leaflet-routing-container .leaflet-routing-header,
    .leaflet-routing-container .leaflet-routing-alternatives {
      flex: 0 0 auto;
    }

    /* ã‚¹ãƒ†ãƒƒãƒ—ä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .leaflet-routing-container .leaflet-routing-step-container {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
    }

    /* ä»£æ›¿ãƒ«ãƒ¼ãƒˆã®è‰²åˆ†ã‘ï¼ˆåœ°å›³ä¸Šï¼‰ */
    .leaflet-routing-alt-line {
      opacity: 0.6;
      stroke-dasharray: 8, 4;
    }

    .leaflet-routing-alt h3 {
      display: none !important;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>
    <div class="panel">
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button id="navModeBtn" class="secondary">ãƒŠãƒ“é–‹å§‹(è»Šã®ã¿)</button>
        <button id="cancelNavBtn" class="secondary">ãƒŠãƒ“å–ã‚Šæ¶ˆã—</button>
      </div>
      <div class="row">ç›®çš„åœ°ã¾ã§ã®æ‰€è¦æ™‚é–“: <span id="eta">---</span></div>
      <div class="row small address-row"
        style="flex-direction: column; align-items: flex-start; gap:2px; margin:0; padding:0;">
        <span style="font-weight:500; color:#555; line-height:1;">
          ä½æ‰€:
          <span id="address" style="font-weight:600; word-break: break-word; line-height:1.2;">---</span>
        </span>
      </div>

      <div class="row small">æœ€çµ‚æ›´æ–°:<span id="lastAge" style="margin-left:8px">---</span></div>
      <h2>ğŸ“ ä½ç½®è¦³æ¸¬ãƒãƒƒãƒ—</h2>
      <div class="info-grid">
        <div class="stat">ç·¯åº¦: <div id="lat">---</div>
        </div>
        <div class="stat">çµŒåº¦: <div id="lng">---</div>
        </div>
        <div class="stat">ç²¾åº¦: <div id="acc">---</div>
        </div>
        <div class="stat">é«˜åº¦: <div id="alt">---</div>
        </div>
        <div class="stat">é€Ÿåº¦: <div id="speed">---</div>
        </div>
        <div class="stat">æ–¹è§’: <div id="heading">---</div>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="controls">
        <button id="stopBtn" class="danger">è¦³æ¸¬åœæ­¢</button>
        <button id="restartBtn">å†é–‹</button>
        <button id="centerToggle" class="secondary">è‡ªå‹•è¿½å°¾: ON</button>
        <button id="exportJsonBtn" class="warning">JSONä¿å­˜</button>
        <button id="exportCsvBtn" class="warning">CSVä¿å­˜</button>
        <button id="clearBtn" class="secondary">ãƒ­ã‚°<br>çµŒè·¯ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="row" style="margin:8px 0;gap:12px;align-items:center">
        <div>ç·è·é›¢: <strong id="totalDist">0 m</strong></div>
        <div>å¹³å‡é€Ÿåº¦: <strong id="avgSpeed">0 km/h</strong></div>
      </div>

      <label id="logToggleLabel"
        style="display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
        éå»ã®ä½ç½®æƒ…å ±ãƒ­ã‚°
        <button id="logToggleBtn" class="secondary" style="font-size:0.8em; padding:2px 6px;">â–¼</button>
      </label>
      <div id="log-container">
        <div id="log"></div>
      </div>

      <div style="margin-top:10px" class="small">â€»ä½ç½®ã®å–å¾—ã¯1ç§’ä»¥ä¸Šé–“éš”ã‚’ç©ºã‘ã¦ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <script>
    let navMode = false;              // ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰ ON/OFF
    let routingControl = null;        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    let currentDestination = null;    // ç›®çš„åœ°ã‚’ä¿æŒ
    let userSelectedRoute = null;     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»£æ›¿ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ãŸå ´åˆã«ä¿æŒ

    // ãƒ­ã‚°UI
    const logToggleBtn = document.getElementById('logToggleBtn');
    const logContainer = document.getElementById('log');

    // ===== ãƒ­ã‚°æŠ˜ã‚ŠãŸãŸã¿ =====
    logToggleBtn.addEventListener('click', () => {
      const logContainer = document.getElementById('log-container');
      const log = document.getElementById('log');
      log.classList.toggle('collapsed');

      if (log.classList.contains('collapsed')) {
        logContainer.style.minHeight = '40px';
        logContainer.style.height = '40px';
        logToggleBtn.textContent = 'â–²';
      } else {
        logContainer.style.height = '';
        logContainer.style.minHeight = '20vh';
        logToggleBtn.textContent = 'â–¼';
      }

      const panel = document.querySelector('.panel');
      panel.scrollTo({ top: panel.scrollHeight, behavior: 'smooth' });
    });

    // ===== ãƒãƒƒãƒ—ãƒ»ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°åˆæœŸåŒ– =====
    let map, marker, watchId = null, pathSegments = [[]], polylines = [], logData = [];
    let lastFetchTime = 0, lastPosTime = 0, follow = true, lastOrientation = null;
    const LS_KEYS = { PATH: 'hp_map_path_v3', LOG: 'hp_map_log_v3' };

    // ===== ãƒãƒƒãƒ—åˆæœŸåŒ– =====
    function initMap() {
      map = L.map('map').setView([35.6812, 139.7671], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
      map.on('dragstart', () => {
        follow = false;
        document.getElementById('centerToggle').textContent = 'è‡ªå‹•è¿½å°¾: OFF';
      });
    }

    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    const toFixedOrDash = (v, d = 6) => typeof v === 'number' ? v.toFixed(d) : '---';
    const now = () => Date.now();
    const haversine = (a, b) => {
      const R = 6371e3, toRad = d => d * Math.PI / 180;
      const Ï†1 = toRad(a[0]), Ï†2 = toRad(b[0]);
      const Î”Ï† = toRad(b[0] - a[0]), Î”Î» = toRad(b[1] - a[1]);
      const aa = Math.sin(Î”Ï† / 2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
    };
    const directionName = deg => {
      if (deg === null || isNaN(deg)) return '---';
      const dirs = ['åŒ—', 'åŒ—æ±', 'æ±', 'å—æ±', 'å—', 'å—è¥¿', 'è¥¿', 'åŒ—è¥¿'];
      return `${dirs[Math.round(deg / 45) % 8]} (${deg.toFixed(0)}Â°)`;
    };

    // ===== è·é›¢ãƒ»é€Ÿåº¦è¨ˆç®— =====
    function calcTotalDistance() {
      return pathSegments.flatMap(seg => seg.slice(1).map((_, i) => haversine(seg[i], seg[i + 1]))).reduce((a, b) => a + b, 0);
    }
    function calcAvgSpeed() {
      if (logData.length < 2) return 0;
      const first = new Date(logData[logData.length - 1]?.time || now()).getTime();
      const last = new Date(logData[0]?.time || now()).getTime();
      const dt = Math.abs(last - first) / 1000;
      return dt <= 0 ? 0 : (calcTotalDistance() / dt) * 3.6;
    }
    function updateStatsUI() {
      document.getElementById('totalDist').textContent = (calcTotalDistance() / 1000).toFixed(3) + ' km';
      document.getElementById('avgSpeed').textContent = calcAvgSpeed().toFixed(2) + ' km/h';
    }

    // ===== ä¿å­˜ãƒ»å¾©å…ƒ =====
    function safeSaveLocal() {
      try {
        localStorage.setItem(LS_KEYS.PATH, JSON.stringify(pathSegments));
        localStorage.setItem(LS_KEYS.LOG, JSON.stringify(logData));
      } catch { }
    }
    function restoreLocal() {
      try {
        const rawP = localStorage.getItem(LS_KEYS.PATH);
        const rawL = localStorage.getItem(LS_KEYS.LOG);
        if (rawP) pathSegments = JSON.parse(rawP);
        if (rawL) logData = JSON.parse(rawL);
        logData.slice(0, 200).forEach(e => addLogEntry(e, true));
      } catch { }
    }

    // ===== ãƒãƒªãƒ©ã‚¤ãƒ³ =====
    function redrawPolylines() {
      const lastSeg = pathSegments[pathSegments.length - 1];
      if (!lastSeg || lastSeg.length === 0) return;

      let lastLine = polylines[polylines.length - 1];
      if (!lastLine || lastLine.getLatLngs().length === 0) {
        lastLine = L.polyline(lastSeg, { color: '#ff4444', weight: 4, opacity: 0.9 }).addTo(map);
        polylines.push(lastLine);
      } else {
        lastLine.addLatLng(lastSeg[lastSeg.length - 1]);
      }
    }

    // ===== ãƒãƒ¼ã‚«ãƒ¼æ›´æ–° =====
    function updateMarker(lat, lng, heading, accColor, speedKmh) {
      const size = speedKmh && speedKmh * 3.6 > 200 ? 20 : 16;
      if (lat === null || lng === null || accColor === null) accColor = 'black';
      if (!marker) {
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width:${size}px;height:${size}px;background:${accColor};border:2px solid #fff;transform:rotate(${heading}deg)"></div>`,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2]
        });
        marker = L.marker([lat, lng], { icon }).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
        const div = marker.getElement().querySelector('div');
        div.style.transform = `rotate(${heading}deg)`;
        div.style.background = accColor;
        div.style.width = div.style.height = size + 'px';
      }
    }

    // ===== ä½æ‰€å–å¾— =====
    async function fetchAddress(lat, lng) {
      if (now() - lastFetchTime < 1000) return 'å–å¾—é–“éš”åˆ¶å¾¡ä¸­';
      if (marker && lastRoutePoint && haversine([lat, lng], lastRoutePoint) < 10)
        return document.getElementById('address').textContent;
      lastFetchTime = now();
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`);
        if (!res.ok) return 'ä½æ‰€å–å¾—å¤±æ•—';
        const data = await res.json();
        const a = data.address || {};
        return [a.country, a.postcode, a.state, a.city || a.town || a.village, a.suburb || a.neighbourhood, a.road].filter(Boolean).join(', ') || data.display_name || 'ä½æ‰€æƒ…å ±ãªã—';
      } catch { return 'ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼'; }
    }

    // ===== ãƒ­ã‚°è¡¨ç¤º =====
    function addLogEntry(e, restoreMode = false) {
      if (!restoreMode) logData.unshift(e);
      const accClass = e.accuracy < 5 ? 'acc-green' : e.accuracy < 15 ? 'acc-yellowgreen' : e.accuracy < 30 ? 'acc-orange' : 'acc-red';
      const html = `<div class="log-entry">
    <div class="time">ğŸ•’ ${new Date(e.time).toLocaleString()}</div>
    <div class="coords">(${e.lat.toFixed(6)}, ${e.lng.toFixed(6)})</div>
    <div class="address">ğŸ“ ${e.address}</div>
    <div class="info">
      <div class="accuracy ${accClass}">ç²¾åº¦:${e.accuracy.toFixed(1)}m</div>
      <div>é€Ÿåº¦:${e.speedText}</div>
      <div>æ–¹è§’:${e.headingText}</div>
    </div>
  </div>`;
      const logElem = document.getElementById('log');
      logElem.insertAdjacentHTML('afterbegin', html);
      // while ã‚’ä½¿ã‚ãšã€ä¸€åº¦ã«å‰Šé™¤ã—ã¦é«˜é€ŸåŒ–
      if (logElem.childElementCount > 200) logElem.removeChild(logElem.lastChild);
      if (!restoreMode) { safeSaveLocal(); updateStatsUI(); }
    }

    // ===== ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
    function download(filename, text) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], { type: 'text/plain' }));
      a.download = filename;
      a.click();
    }
    document.getElementById('exportJsonBtn').addEventListener('click', () => download('location_log.json', JSON.stringify({ pathSegments, logData, savedAt: new Date().toISOString() }, null, 2)));
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
      const h = ['time,lat,lng,accuracy,speed_kmh,heading,address'];
      const rows = logData.map(e => `${JSON.stringify(e.time)},${e.lat},${e.lng},${e.accuracy},${parseFloat(e.speedKmh) || ''},${JSON.stringify(e.headingText)},${JSON.stringify(e.address)}`);
      download('location_log.csv', h.concat(rows).join('\n'));
    });

    // ===== æ“ä½œãƒœã‚¿ãƒ³ =====
    document.getElementById('stopBtn').addEventListener('click', () => { if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; pathSegments.push([]); alert('è¦³æ¸¬åœæ­¢'); } });
    document.getElementById('restartBtn').addEventListener('click', () => { if (!watchId) startTracking(); alert('è¦³æ¸¬å†é–‹'); });
    document.getElementById('clearBtn').addEventListener('click', () => { if (confirm('æœ¬å½“ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) { pathSegments = [[]]; logData = []; redrawPolylines(); document.getElementById('log').innerHTML = ''; safeSaveLocal(); updateStatsUI(); } });
    document.getElementById('centerToggle').addEventListener('click', async () => {
      follow = !follow;
      document.getElementById('centerToggle').textContent = `è‡ªå‹•è¿½å°¾: ${follow ? 'ON' : 'OFF'}`;

      if (follow && marker) {
        const pos = marker.getLatLng();

        // ç¾åœ¨åœ°ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç§»å‹•ï¼†ã‚ºãƒ¼ãƒ 
        map.flyTo(pos, 17, { animate: true, duration: 1.2 }); // durationã¯ç§’

        // ç¾åœ¨åœ°ã®ä½æ‰€ã‚’æ›´æ–°
        const addr = await fetchAddress(pos.lat, pos.lng);
        document.getElementById('address').textContent = addr;

        // è¿½å°¾ä¸­ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³å¯èƒ½
        map.dragging.enable();
        map.touchZoom.enable();
        map.scrollWheelZoom.enable();
        map.doubleClickZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();
      } else {
        // è¿½å°¾OFFæ™‚ã¯è‡ªç”±æ“ä½œã®ã¾ã¾ï¼ˆå¿…è¦ãªã‚‰ç„¡åŠ¹åŒ–ã‚‚å¯ï¼‰
      }
    });


    // ===== ä½ç½®æ›´æ–° =====
    let lastRouteUpdate = 0;
    let lastRoutePoint = null;
    let lastAddressTime = 0;

    async function handlePosition(pos) {
      if (!pos || !pos.coords) {
        updateMarker(null, null, 0, 'black', 0);
        return;
      }

      const c = pos.coords;
      const lat = c.latitude,
        lng = c.longitude,
        acc = c.accuracy || 0,
        alt = c.altitude;
      let speed = (c.speed >= 0) ? c.speed : null;
      let heading = (typeof c.heading === 'number') ? c.heading : null;

      // ãƒ‘ã‚¹ã®ç›´å‰ç‚¹å–å¾—
      const lastSegment = pathSegments[pathSegments.length - 1];
      const prev = lastSegment ? lastSegment.slice(-1)[0] : null;
      const nowTime = Date.now();

      // ===== é€Ÿåº¦ãƒ»æ–¹è§’è¨ˆç®— =====
      if (prev) {
        const dt = (pos.timestamp - lastPosTime) / 1000;
        if ((!speed || speed === 0) && dt > 0) speed = haversine(prev, [lat, lng]) / dt;
        if ((heading === null || isNaN(heading)) && dt > 0) {
          const dy = lat - prev[0], dx = lng - prev[1];
          heading = Math.atan2(dx, dy) * 180 / Math.PI;
          if (heading < 0) heading += 360;
        }
      }

      if (lastOrientation !== null) heading = lastOrientation;
      heading = (heading === null || isNaN(heading)) ? 0 : heading;

      const accColor = acc < 5 ? 'green' : acc < 15 ? 'yellowgreen' : acc < 30 ? 'orange' : 'red';

      // ===== UIæ›´æ–° =====
      document.getElementById('lat').textContent = toFixedOrDash(lat, 6);
      document.getElementById('lng').textContent = toFixedOrDash(lng, 6);
      document.getElementById('acc').textContent = `${acc.toFixed(1)} m`;
      document.getElementById('alt').textContent = alt === null ? '---' : `${alt.toFixed(1)} m`;
      document.getElementById('speed').textContent = speed ? `${(speed * 3.6).toFixed(1)} km/h` : '---';
      document.getElementById('heading').textContent = directionName(heading);
      document.getElementById('acc').style.color = accColor;

      // ===== ãƒ‘ã‚¹æ›´æ–° & ãƒãƒ¼ã‚«ãƒ¼ =====
      const shouldUpdateMarker = !marker || !prev || haversine(prev, [lat, lng]) > 0.5;
      if (shouldUpdateMarker) {
        if (!lastSegment) pathSegments.push([]);
        pathSegments[pathSegments.length - 1].push([lat, lng]);
        redrawPolylines();
        updateMarker(lat, lng, heading, accColor, speed);
      }

      if (follow && map) map.panTo([lat, lng], { animate: true });

      // ===== ä½æ‰€æ›´æ–°ï¼ˆ1ç§’é–“éš”ï¼‰ =====
      const addrElem = document.getElementById('address');
      if (!routingControl && nowTime - lastAddressTime > 1000) {
        const addr = await fetchAddress(lat, lng);
        addrElem.textContent = addr;
        lastAddressTime = nowTime;
      }

      // ===== ãƒ­ã‚°è¿½åŠ  =====
      addLogEntry({
        time: new Date().toISOString(),
        lat, lng, accuracy: acc, altitude: alt,
        speedKmh: speed ? speed * 3.6 : null,
        speedText: speed ? `${(speed * 3.6).toFixed(1)} km/h` : '---',
        headingText: directionName(heading),
        address: addrElem.textContent
      });

      // ===== ãƒŠãƒ“ä¸­ãƒ«ãƒ¼ãƒˆæ›´æ–°ï¼ˆè·é›¢ãƒ»æ™‚é–“åˆ¶é™ï¼‰ =====
      const current = [lat, lng];
      if (routingControl && currentDestination && !userSelectedRoute) {
        const distMoved = lastRoutePoint ? haversine(lastRoutePoint, current) : Infinity;
        if (distMoved > 30 && nowTime - lastRouteUpdate > 5000) {
          routingControl.setWaypoints([L.latLng(lat, lng), currentDestination]);
          lastRoutePoint = current;
          lastRouteUpdate = nowTime;
        }
      }

      lastPosTime = pos.timestamp || Date.now();
      document.getElementById('lastAge').textContent = '0ç§’å‰';
    }


    // ===== ã‚¨ãƒ©ãƒ¼å‡¦ç† =====
    let retryTimer = null;
    function handleError(err) { console.warn('ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼', err); if (!retryTimer) retryTimer = setTimeout(() => { startTracking(); }, 3000); }

    // ===== è¿½è·¡é–‹å§‹ =====
    async function startTracking() {
      if (!navigator.geolocation) { alert('ä½ç½®æƒ…å ±æœªå¯¾å¿œ'); return; }

      // åˆå›å–å¾—ï¼ˆä½ç²¾åº¦ã§å³æ™‚è¡¨ç¤ºï¼‰
      navigator.geolocation.getCurrentPosition(
        pos => handlePosition(pos),
        err => console.warn('åˆå›å–å¾—å¤±æ•—', err),
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 5000 }
      );

      // ç¶™ç¶šè¿½è·¡ï¼ˆé«˜ç²¾åº¦ï¼‰
      watchId = navigator.geolocation.watchPosition(
        pos => handlePosition(pos),
        err => console.warn('è¿½è·¡å–å¾—ã‚¨ãƒ©ãƒ¼', err),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 1000 }
      );
    }

    // ===== æ›´æ–°æ™‚é–“è¡¨ç¤º =====
    setInterval(() => {
      if (lastPosTime) {
        const deltaSec = Math.floor((now() - lastPosTime) / 1000);
        const h = Math.floor(deltaSec / 3600), m = Math.floor((deltaSec % 3600) / 60), s = deltaSec % 60;
        let text = '';
        if (h > 0) text += `${h}æ™‚é–“`;
        if (m > 0 || h > 0) text += `${m}åˆ†`;
        text += `${s}ç§’å‰`;
        document.getElementById('lastAge').textContent = text;
      }
    }, 1000);

    // ===== DeviceOrientation =====
    async function setupDeviceOrientation() {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        const btn = document.createElement('button');
        btn.textContent = 'ã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯';
        btn.className = 'warning';
        btn.style.margin = '6px';
        document.querySelector('.panel').appendChild(btn);
        btn.addEventListener('click', async () => {
          const perm = await DeviceOrientationEvent.requestPermission();
          if (perm === 'granted') { window.addEventListener('deviceorientationabsolute', onDeviceOrientation); btn.remove(); } else alert('æ‹’å¦');
        });
      } else if (window.DeviceOrientationEvent) window.addEventListener('deviceorientationabsolute', onDeviceOrientation);
    }
    function onDeviceOrientation(e) {
      if (e && typeof e.alpha === 'number') {
        lastOrientation = (360 - e.alpha) % 360;
        document.getElementById('heading').textContent = directionName(lastOrientation);
        if (marker) marker.getElement().querySelector('div').style.transform = `rotate(${lastOrientation}deg)`;
      }
    }

    // ===== åˆæœŸãƒ­ãƒ¼ãƒ‰ =====
    window.addEventListener('load', () => {
      initMap();
      restoreLocal();
      redrawPolylines();
      setupDeviceOrientation();
      startTracking();

      const navModeBtn = document.getElementById("navModeBtn");
      navModeBtn.addEventListener("click", () => { navMode = !navMode; navModeBtn.textContent = navMode ? "åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ç›®çš„åœ°ã‚’é¸æŠä¸­â€¦" : "ãƒŠãƒ“é–‹å§‹(è»Šã®ã¿)"; });

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§ç›®çš„åœ°é¸æŠ
      map.on("click", async e => {
        if (!navMode) return;
        if (!marker) { alert("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™ã€‚ä½ç½®ãŒç¢ºå®šã—ãŸã‚‰ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚"); return; }

        currentDestination = e.latlng;
        userSelectedRoute = false;  // æ–°ã—ã„ç›®çš„åœ°é¸æŠæ™‚ã¯ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ

        const destAddress = await fetchAddress(currentDestination.lat, currentDestination.lng);
        document.getElementById("address").textContent = destAddress;

        const start = marker.getLatLng();
        const dest = currentDestination;

        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
          waypoints: [start, dest],
          routeWhileDragging: false,
          addWaypoints: false,
          draggableWaypoints: false,
          showAlternatives: true,
          fitSelectedRoutes: false,
          language: "en",
          lineOptions: { styles: [{ color: "#1976d2", weight: 7, opacity: 1 }] },
          altLineOptions: () => ({ color: "#f44336", weight: 5, opacity: 1 }),
          createMarker: (i, wp) => {
            const size = 20, color = i === 0 ? "#00BCD4" : "#800080";
            return L.marker(wp.latLng, {
              icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="width:${size}px;height:${size}px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
              })
            });
          },
          position: 'bottomright'
        })
          // ==== æ–°ã—ãè¿½åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ ====
          .on("routingstart", () => {
            document.getElementById("eta").textContent = "è¨ˆç®—ä¸­...";
          })
          .on("routesfound", e => updateEta(e.routes[0]))
          .on("routingerror", () => {
            document.getElementById("eta").textContent = "çµŒè·¯å–å¾—å¤±æ•—";
          })
          .on("routeselected", e => {
            updateEta(e.route);
            userSelectedRoute = true;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»£æ›¿ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ãŸã‚‰ãƒ•ãƒ©ã‚°ON
          })
          .addTo(map);

        navMode = false;
        document.getElementById("navModeBtn").textContent = "ãƒŠãƒ“é–‹å§‹(è»Šã®ã¿)";
      });

      function updateEta(route) {
        if (!route) return;
        const summary = route.summary;
        const distKm = (summary.totalDistance / 1000).toFixed(2);
        let totalSec = summary.totalTime;
        const hours = Math.floor(totalSec / 3600);
        const minutes = Math.round((totalSec % 3600) / 60);
        let timeText = '';
        if (hours > 0) timeText += `${hours}æ™‚é–“`;
        timeText += `${minutes}åˆ†`;
        document.getElementById("eta").textContent = `${distKm} km / ç´„ ${timeText}`;
      }
    });

    // ===== ãƒŠãƒ“ã‚­ãƒ£ãƒ³ã‚»ãƒ« =====
    cancelNavBtn.addEventListener("click", async () => {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; }
      navMode = false;
      document.getElementById("navModeBtn").textContent = "ãƒŠãƒ“é–‹å§‹(è»Šã®ã¿)";
      currentDestination = null;
      userSelectedRoute = false;  // ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ

      // ç¾åœ¨åœ°ä½æ‰€ã«æˆ»ã™
      if (marker) {
        const currentLatLng = marker.getLatLng();
        const address = await fetchAddress(currentLatLng.lat, currentLatLng.lng);
        document.getElementById("address").textContent = address;
      }

      // ETAãƒªã‚»ãƒƒãƒˆ
      const etaContainer = document.getElementById("eta");
      if (etaContainer) etaContainer.textContent = "---";
    });

  </script>


</body>

</html>